name: Daily Release Check

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  RELEASE_BRANCH: release

jobs:
  check-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder curl jq

    - name: Add Flathub repository
      run: |
        flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    - name: Check latest Servo release
      id: check-release
      run: |
        # Get latest Servo release info
        LATEST_RELEASE=$(curl -sL https://api.github.com/repos/servo/servo/releases/latest)
        SERVO_VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
        SERVO_NAME=$(echo "$LATEST_RELEASE" | jq -r '.name')

        echo "servo_version=$SERVO_VERSION" >> $GITHUB_OUTPUT
        echo "servo_name=$SERVO_NAME" >> $GITHUB_OUTPUT
        echo "Latest Servo release: $SERVO_VERSION ($SERVO_NAME)"

        # Check if we already have this release
        if git ls-remote --tags origin | grep -q "refs/tags/$SERVO_VERSION"; then
          echo "release_exists=true" >> $GITHUB_OUTPUT
          echo "Release $SERVO_VERSION already exists, skipping..."
        else
          echo "release_exists=false" >> $GITHUB_OUTPUT
          echo -e "\033[32mNew release $SERVO_VERSION found, proceeding...\033[0m"
        fi

    - name: Cache Servo release info
      if: steps.check-release.outputs.release_exists == 'false'
      run: |
        curl -sL https://api.github.com/repos/servo/servo/releases/latest -o .servo.github.json
    
    - name: Generate manifest
      if: steps.check-release.outputs.release_exists == 'false'
      run: |
        make org.servo.Servo.yml

    - name: Validate generated manifest
      if: steps.check-release.outputs.release_exists == 'false'
      run: |
        if [ ! -f org.servo.Servo.yml ]; then
          echo -e "\033[31mError: org.servo.Servo.yml was not generated\033[0m"
          exit 1
        fi
        
        # Check that placeholders were replaced
        if grep -q '\[RUNTIME_VERSION\]' org.servo.Servo.yml; then
          echo -e "\033[31mError: RUNTIME_VERSION placeholder not replaced\033[0m"
          exit 1
        fi
        if grep -q '\[SERVO_TAR_URL\]' org.servo.Servo.yml; then
          echo -e "\033[31mError: SERVO_TAR_URL placeholder not replaced\033[0m"
          exit 1
        fi
        if grep -q '\[SERVO_TAR_SHA256\]' org.servo.Servo.yml; then
          echo -e "\033[31mError: SERVO_TAR_SHA256 placeholder not replaced\033[0m"
          exit 1
        fi

        echo -e "\033[32mâœ“ Manifest validation passed\033[0m"

    - name: Configure Git
      if: steps.check-release.outputs.release_exists == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Copy the file to dist directory
      if: steps.check-release.outputs.release_exists == 'false'
      run: |
        mkdir -p dist
        cp -pdf org.servo.Servo.yml dist/

    - name: Get the SHA3384 checksum for the yml
      if: steps.check-release.outputs.release_exists == 'false'
      id: sha384sum
      run: |
        cd dist/
        sha384sum org.servo.Servo.yml > org.servo.Servo.yml.sha384sum
        echo "checksum=$(cat org.servo.Servo.yml.sha384sum)" >> $GITHUB_OUTPUT

    - name: Creating icons.tar.gz archive
      if: steps.check-release.outputs.release_exists == 'false'
      run: |
        make icons.tar.gz
        sha384sum icons.tar.gz > icons.tar.gz.sha384sum

    - name: Create release branch and commit
      if: steps.check-release.outputs.release_exists == 'false'
      run: |
        SERVO_VERSION="${{ steps.check-release.outputs.servo_version }}"
        SERVO_NAME="${{ steps.check-release.outputs.servo_name }}"
        BRANCH="${{ env.RELEASE_BRANCH }}"

        # Add the generated manifest
        echo -e "\033[34mAdding generated manifest to branch...\033[0m"
        git add dist/org.servo.Servo.yml
        git add dist/org.servo.Servo.yml.sha384sum
        git commit -m "Release $SERVO_VERSION" -m "Automated release for Servo $SERVO_NAME" -m "Generated manifest for Flatpak packaging."

        # Check if release branch exists, create if not
        echo -e "\033[34mChecking if release branch \"${BRANCH}\" exists...\033[0m"
        git ls-remote --heads origin ${BRANCH}
        if git ls-remote --heads origin ${BRANCH} | grep "refs/heads/${BRANCH}\$" 2>/dev/null; then
          echo -e "\033[34mRelease branch exists, checking out...\033[0m"
          git fetch origin ${BRANCH}
          git rebase origin/${BRANCH}
        else
          echo -e "\033[34mRelease branch does not exist, creating...\033[0m"
          git checkout -b ${BRANCH}
        fi

        # Tag the commit
        git tag -a "$SERVO_VERSION" -m "Servo $SERVO_NAME"
        
        # Push branch and tag
        git push origin ${BRANCH}
        git push origin "$SERVO_VERSION"

    - name: Create GitHub Release
      if: steps.check-release.outputs.release_exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.check-release.outputs.servo_version }}
        name: Servo ${{ steps.check-release.outputs.servo_name }}
        body: |
          Automated Flatpak manifest for Servo ${{ steps.check-release.outputs.servo_name }}

          This release contains the `org.servo.Servo.yml` manifest file that can be used to build a Flatpak package of Servo.

          **Upstream Release:** https://github.com/servo/servo/releases/tag/${{ steps.check-release.outputs.servo_version }}

          ## Usage

          To build and install the Flatpak:

          ```bash
          curl -Ls -o org.servo.Servo.yml https://github.com/yookoala/servo-flatpak/releases/download/${{ steps.check-release.outputs.servo_version }}/org.servo.Servo.yml
          echo "${{ steps.sha384sum.outputs.checksum }}" | sha384sum --check && flatpak-builder --user --install --force-clean build-dir org.servo.Servo.yml || echo -e "\033[31mchecksum mismatch\033[0m"
          ```

          This will download the [manifest file][manifest-file]. And it will download the [${{ steps.check-release.outputs.servo_version }} tag release from the upstream GitHub][upstream-github].

          To run Servo after installation:

          ```bash
          flatpak run org.servo.Servo
          ```

          or use the relevant flatpak desktop shortcut.

          [manifest-file]: https://raw.githubusercontent.com/yookoala/servo-flatpak/refs/tags/${{ steps.check-release.outputs.servo_version }}/dist/org.servo.Servo.yml
          [upstream-github]: https://github.com/servo/servo/releases/tag/${{ steps.check-release.outputs.servo_version }}
        files: |
          dist/org.servo.Servo.yml
          dist/org.servo.Servo.yml.sha384sum
          icons.tar.gz
          icons.tar.gz.sha384sum
        draft: false
        prerelease: false
