name: Test Flatpak Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Cache Servo GitHub release info
      uses: actions/cache@v4
      with:
        path: .servo.github.json
        key: servo-release-${{ github.run_id }}
        restore-keys: |
          servo-release-

    - name: Install Flatpak and dependencies
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: flatpak,flatpak-builder
    
    - name: Generate .env file with GitHub credentials
      env:
        GITHUB_CLIENT_ID: ${{ secrets.GITHUB_CLIENT_ID }}
        GITHUB_CLIENT_SECRET: ${{ secrets.GITHUB_CLIENT_SECRET }}
      run: |
        if [ -n "$GITHUB_CLIENT_ID" ] && [ -n "$GITHUB_CLIENT_SECRET" ]; then
          echo "GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID" > .env
          echo "GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET" >> .env
        fi

    - name: Generate manifest from template
      run: |
        make org.servo.Servo.yml
    
    - name: Validate generated manifest
      run: |
        if [ ! -f org.servo.Servo.yml ]; then
          echo "Error: org.servo.Servo.yml was not generated"
          exit 1
        fi
        echo "✓ Manifest file generated successfully"
        
        # Check that placeholders were replaced
        if grep -q '\[RUNTIME_VERSION\]' org.servo.Servo.yml; then
          echo "Error: RUNTIME_VERSION placeholder not replaced"
          exit 1
        fi
        if grep -q '\[SERVO_TAR_URL\]' org.servo.Servo.yml; then
          echo "Error: SERVO_TAR_URL placeholder not replaced"
          exit 1
        fi
        if grep -q '\[SERVO_TAR_SHA256\]' org.servo.Servo.yml; then
          echo "Error: SERVO_TAR_SHA256 placeholder not replaced"
          exit 1
        fi
        echo "✓ All placeholders replaced successfully"
    
    - name: Build Flatpak (dry-run)
      run: |
        flatpak-builder --disable-download --stop-at=servo build-dir org.servo.Servo.yml || true
        echo "✓ Flatpak manifest syntax is valid"
    
    - name: Upload generated manifest as artifact
      uses: actions/upload-artifact@v4
      with:
        name: servo-flatpak-manifest
        path: org.servo.Servo.yml
        retention-days: 7
